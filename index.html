<!DOCTYPE html>

<head>
    <link rel="shortcut icon" href="#" />
    <meta charset="utf-8" />
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style></style>
</head>

<body>
    <script>

        Promise.all([

            d3.json("/data_final/listing_G.json"),
            d3.json("/data_final/listing_R.json"),
            d3.json("/data_final/chronology_G.json"),
            d3.json("/data_final/chronology_R.json")

        ]).then(function (jsons) {
            var listing_G = jsons[0];
            var listing_R = jsons[1];
            var chronology_G = jsons[2];
            var chronology_R = jsons[3];

            delete chronology_R['2014-12-25'];

            // console.log(listing_G);
            // console.log(listing_R);
            // console.log(chronology_G);
            // console.log(chronology_R);

            // convert ms to hh:mm:ss
            function msToTime(s) {
                // Pad to 2 or 3 digits, default is 2
                var pad = (n, z = 2) => ('00' + n).slice(-z);
                return pad(s / 3.6e6 | 0) + ':' + pad((s % 3.6e6) / 6e4 | 0) + ':' + pad((s % 6e4) / 1000 | 0) + '.' + pad(s % 1000, 3);
            }
            // convert ms to dd:hh:mm
            function dhm(t) {
                var cd = 24 * 60 * 60 * 1000,
                    ch = 60 * 60 * 1000,
                    d = Math.floor(t / cd),
                    h = Math.floor((t - d * cd) / ch),
                    m = Math.round((t - d * cd - h * ch) / 60000),
                    pad = function (n) { return n < 10 ? '0' + n : n; };
                if (m === 60) {
                    h++;
                    m = 0;
                }
                if (h === 24) {
                    d++;
                    h = 0;
                }
                return [d, pad(h), pad(m)].join(':');
            }

            // average listening time per hour, day, week, month, year since first day
            // average listen time per hour, detailed
            // session stats
            function average_listens_and_sessions(chronology, since_start_date) {
                var listen_time_per_hour_detailed = [];
                for (let i = 0; i < 24; i++) { listen_time_per_hour_detailed[i] = 0; }
                var session_lengths = [];
                for (let i = 1; i < 18; i++) { session_lengths[i] = 0; }
                var total_sessions = [];
                var total_listen_time = 0;
                Object.keys(chronology).forEach(function (day) {
                    chronology[day]['sessions'].forEach(([start, end]) => {
                        session_lengths[end - start + 1]++;
                        total_sessions.push([start, end]);
                    });
                    Object.keys(chronology[day]).forEach(function (time) {
                        var hour = time.substr(0, 2);
                        var ms_played = chronology[day][time]['ms_played'];
                        if (typeof ms_played !== 'undefined') {
                            total_listen_time += ms_played;
                            listen_time_per_hour_detailed[parseInt(hour)] += ms_played;
                        }
                    });
                });
                for (let i = 0; i < 24; i++) {
                    listen_time_per_hour_detailed[i] *= 1.66667e-5;
                    listen_time_per_hour_detailed[i] /= since_start_date['days_since_start_date'];
                }
                var total_sessions = total_sessions.sort(function (a, b) {
                    if (a[0] == b[0]) return a[1] - b[1];
                    return a[0] - b[0];
                });
                var sessions_detailed = {};
                total_sessions.forEach(([start, end]) => {
                    if (sessions_detailed.hasOwnProperty([start, end])) sessions_detailed[[start, end]] += 1;
                    else sessions_detailed[[start, end]] = 1;
                });
                var average_listen_time_per_hour = total_listen_time / since_start_date['hours_since_start_date'];
                var average_listen_time_per_day = total_listen_time / since_start_date['days_since_start_date'];
                var average_listen_time_per_week = total_listen_time / since_start_date['weeks_since_start_date'];
                var average_listen_time_per_month = total_listen_time / since_start_date['months_since_start_date'];
                var average_listen_time_per_year = total_listen_time / since_start_date['years_since_start_date'];

                // average listening time per hour in the day, in minutes. array of 24 values where the index is the hour in the day
                console.log("listen time per hour detailed");
                console.log(listen_time_per_hour_detailed);
                // average listening time per hour since the beginning in ms
                console.log("average listen time per hour: " + msToTime(average_listen_time_per_hour));
                // average listening time per day since the beginning in ms
                console.log("average listen time per day: " + msToTime(average_listen_time_per_day));
                // average listening time per hour since the beginning in ms
                console.log("average listen time per week: " + msToTime(average_listen_time_per_week));
                // average listening time per hour since the beginning in ms
                console.log("average listen time per month: " + msToTime(average_listen_time_per_month));
                // average listening time per hour since the beginning in ms
                console.log("average listen time per year: " + dhm(average_listen_time_per_year) + " (dd:hh:mm)");
                // listing of all sessions from the beginning, represented by [start_hour, end_hour]
                console.log("total sessions");
                console.log(total_sessions);
                // object with keys the specific sessions (as in instances of [start, end]) and values the number of times these sessions happened
                console.log("sessions detailed");
                console.log(sessions_detailed);
                // array of values corresponding to the number of sessions of length equal to the index in the array
                console.log("session lengths");
                console.log(session_lengths);
                // total listening time from the beginning
                console.log("total listen time");
                console.log(dhm(total_listen_time) + " (dd:hh:mm)");
            }

            // average number of albums listened to per artists, songs per album, songs per artists
            function average_and_total_figures(listing) {
                var total_artists = 0;
                var total_albums = 0;
                var total_songs = 0;
                Object.keys(listing).forEach(function (artist) {
                    total_artists++;
                    Object.keys(listing[artist]).forEach(function (album) {
                        total_albums++;
                        Object.keys(listing[artist][album]).forEach(function (song) {
                            total_songs++;
                        });
                    });
                });
                var average_albums_per_artist = total_albums / total_artists;
                var average_songs_per_artist = total_songs / total_artists;
                var average_songs_per_album = total_songs / total_albums;
                console.log("total number of artists: " + total_artists);
                console.log("total number of albums: " + total_albums);
                console.log("total number of songs: " + total_songs);
                console.log("average number of albums listened to per artist: " + average_albums_per_artist);
                console.log("average number of songs listened to per artist: " + average_songs_per_artist);
                console.log("average number of songs listened to per album: " + average_songs_per_album);
            }

            since_start_date_G = {};
            since_start_date_G['hours_since_start_date'] = 50327;
            since_start_date_G['days_since_start_date'] = 2096;
            since_start_date_G['weeks_since_start_date'] = 299;
            since_start_date_G['months_since_start_date'] = 69;
            since_start_date_G['years_since_start_date'] = 5.74;
            console.log("Guillaume");
            average_listens_and_sessions(chronology_G, since_start_date_G);
            average_and_total_figures(listing_G);
            since_start_date_R = {};
            since_start_date_R['hours_since_start_date'] = 55943;
            since_start_date_R['days_since_start_date'] = 2330;
            since_start_date_R['weeks_since_start_date'] = 332;
            since_start_date_R['months_since_start_date'] = 76;
            since_start_date_R['years_since_start_date'] = 6.38;
            console.log("Rafael");
            average_listens_and_sessions(chronology_R, since_start_date_R);
            average_and_total_figures(listing_R);

        });
    </script>
</body>